# Roadmap: Industrial Energy Synth (VST3, JUCE) — v1.0 (MVP)

Цель v1.0: монофонический VST3-синтезатор под Windows 10/11 (x64) для агрессивных индустриальных тембров ("ломаем звук"), но с жёстким следованием высоты MIDI-нотам (pitch остаётся нотой, а не хаосом). Основная DAW для тестов: Reaper; дополнительно: FL Studio, Cakewalk.

## Definition Of Done (v1.0)
- VST3 стабильно работает в Reaper (длительная сессия, автомейшн параметров, смена SR/Buffer).
- Обработка аудио: 32-bit float; sample rate и buffer size наследуются от хоста.
- MIDI Note On/Off + Velocity отрабатывают корректно; при экстремальных искажениях высота остаётся читаемой и следует MIDI.
- Способен уверенно выдавать характеры: "гул", "визг", "болгарка", при этом ноты читаемы; бас держит фундамент, лид пробивает микс.
- Моно, last-note priority, Glide On/Off + Time.
- 2 осциллятора (Saw/Square/Triangle) с Coarse/Fine/Phase/Detune; sync Osc2 → Osc1.
- Цепь разрушения (последовательно): Wavefold -> Hard Clip -> RingMod/FМ (переключаемо) -> Bitcrusher/SRR, с параметрами Drive/Amount/Mix (+ синхронизация к частоте ноты там, где применимо).
- Фильтр после искажений: LP/BP, резонанс до самовозбуждения, keytracking (вкл/выкл).
- 2 ADSR: Amp + Filter.
- Пресеты: встроенные factory (12–15) + пользовательские (сохранение/загрузка).
- UI: блоки Oscillators / Distortion / Filter / Envelopes / Output, управление только крутилками и переключателями.
- UI: переключаемые языки RU/EN (без "крякозябр" и развала верстки).

## Changelog

### 0.1.0 (2026-02-10)
- APVTS: параметры + state save/load (проекты DAW восстанавливают всё 1:1).
- Моно-движок: last-note priority, Glide, режим огибающих Retrigger/Legato.
- Осцилляторы: 2x polyBLEP (Saw/Square/Triangle) + hard sync Osc2→Osc1.
- DestroyChain v1: fold/clip/ringmod|FM/crush с dry/wet и сглаживанием.
- Фильтр после искажений (LP/BP) + Filter ADSR, Amp ADSR.
- RU/EN переключение языка (параметр `ui.language`) + подсказки.
- UI: Serum-ish разметка блоков, ресайз (угол + границы), hover status line, peak meter, Panic, user/factory presets.
- Tone EQ + интерактивный спектр-анализатор: low/high cut + peak (drag), Shift-drag меняет Q, double-click сбрасывает.

### 0.1.1 (2026-02-10)
- Tone EQ улучшен: теперь 3 peak-узла (1/2/3) для более точного “скульптинга” спектра мышью.
- Factory presets доведены до 15 (минимальный набор v1.0 выполнен).

### 0.1.2 (2026-02-10)
- Tone EQ: добавлены peak-узлы до 8 шт (слоты 1..8) с включением/выключением.
- Tone EQ UX: double-click по пустому месту на спектре добавляет новый peak (если есть свободный слот), ПКМ по peak удаляет (disable).
- UI: более спокойный фон/градиенты (меньше “шума”), сохранив технический/Serum-ish характер.

### 0.1.3 (2026-02-10)
- Destroy: добавлен Oversampling (OS) Off/2x/4x для снижения алиасинга в Fold/Clip/Mod (CPU выше).

### 0.1.4 (2026-02-10)
- Modulation v1: 2x LFO (free/sync к BPM), 2x Macros (0..1) как источники.
- Mod Matrix (8 слотов): Source + Destination + bipolar Depth (без drag-drop пока).
- Реальная модуляция в движке (sample-rate): Osc уровни, Filter cutoff/resonance, Destroy Amounts (fold/clip/mod) + crush mix.
- UI: добавлен блок Modulation (Macros/LFO/Matrix), RU/EN подписи и подсказки.

### 0.1.5 (2026-02-10)
- Modulation UX: drag-and-drop назначение модуляции (Serum-like) из LFO/Macro на ручки.
- Визуал: “кольца” модуляции вокруг ручек + подсветка цели при перетаскивании.
- Контекстное меню на ручке (ПКМ): удалить модуляции для этой ручки / удалить отдельный слот.

### 0.1.6 (2026-02-10)
- Modulation UX: “кольцо” модуляции теперь можно тянуть мышью (drag) для изменения глубины (Shift = fine), как в Serum.
- Визуал: дуги модуляции показывают направление (плюс/минус) от базового значения ручки.

### 0.1.7 (2026-02-10)
- Modulation UX: Alt-клик по кольцу модуляции быстро удаляет модуляции для ручки (без меню).
- Инженерия: уменьшено дублирование ID-таблиц Mod Matrix в UI-коде (меньше шансов на рассинхрон).

### 0.1.8 (2026-02-10)
- M9 QA: добавлен чек-лист тестирования под Reaper (`IES_QA.md`).
- Build UX: добавлены `CMakePresets.json` + PowerShell-скрипты сборки/установки (`scripts/build-win.ps1`, `scripts/install-vst3.ps1`).
- Авто-тесты (опционально): добавлен минимальный `ctest`-таргет (`IES_BUILD_TESTS=ON`) для проверки NoteStackMono (last-note правила).
- Dev UX: добавлен `scripts/clean-build.ps1` для безопасной очистки build-папок.
- UI Layout: добавлено переключение интерфейса на 2 страницы (`Synth` / `Mod`) для работы в меньшем окне без перегруза.

### 0.1.9 (2026-02-11)
- Tone/Spectrum: добавлены режимы анализатора `PRE/POST` (до Destroy / после полной цепи).
- Tone/Spectrum: добавлен `Freeze` (заморозка кадра анализатора) для точной настройки.
- Tone/Spectrum: добавлен `Averaging` (`Fast/Medium/Smooth`) для контроля инерции спектра.

### 0.1.10 (2026-02-11)
- UI Layout: удалён отдельный блок `Output`; параметр `Gain` перенесён в блок `Mono` (под `Glide Time`) для экономии места.
- UI Layout: переработана сетка страницы `Synth` (меньше пустого пространства, более плотная компоновка на широких/узких окнах).
- UI Fixes: исправлен клиппинг контролов/лейблов в `Destroy` и `Filter`, увеличены рабочие высоты строк и внутренние отступы.
- UX/Readability: увеличены поля значений в dense-блоках, принудительно обновляется формат текста значений после инициализации.
- New Functionality: double-click по заголовку `Destroy` сбрасывает весь блок `Destroy` к дефолтным значениям.

## Архитектура (целевая на MVP)
- `AudioProcessorValueTreeState` (APVTS) как единый источник параметров и состояния.
- Моно-движок без `juce::Synthesiser` (или 1 voice), с явным note-stack и last-note priority.
- DSP блоки в фиксированном порядке: OscMix -> DestroyChain -> Filter -> AmpEnv -> Output.
- Везде где нужно: сглаживание параметров (минимум cutoff/gain/drive/mix/glide), `ScopedNoDenormals`.

## Этапы / Milestones

## Текущий статус (ветка разработки)
- M0–M8: реализовано (ядро синта, destroy, фильтр+огибающие, пресеты, RU/EN UI, ресайз, Spectrum/Tone).
- M9: осталось ручное QA/оптимизация/релизная сборка (см. чек-лист ниже).

### M0. Скелет проекта и сборка (инфраструктура)
**Задачи**
- Создать JUCE-проект (CMake или Projucer) под VST3 (и опционально Standalone для отладки).
- Настроить сборку на Windows (VS2022), базовую структуру `Source/`.
- Добавить минимальный CI (опционально) или скрипт сборки.

**Артефакты**
- Репозиторий собирается в VST3 на Windows, плагин грузится в Reaper.

**Критерии**
- Пустой плагин проходит скан VST3 в Reaper/DAW, нет крашей при открытии/закрытии проекта.

---

### M1. Параметры и состояние (APVTS)
**Задачи**
- Специфицировать список параметров (ID, диапазоны, skew, единицы).
- Реализовать `getStateInformation`/`setStateInformation` через ValueTree/XML.
- Сформировать основу для пресетов (пока без UI).

**Критерии**
- Сохранение/загрузка проекта DAW восстанавливает все параметры 1:1.

---

### M2. Моно-синтез ядро: MIDI, нота, Glide
**Задачи**
- Обработка MIDI: note on/off, velocity, last-note priority (note stack).
- Glide/Portamento: On/Off + Time (экспоненциальная/линейная интерполяция частоты).
- Key tracking 100%: осцилляторы строго следуют текущей ноте/глайду.

**Критерии**
- В Reaper MIDI-ноты играются корректно, легато/перекрытия ведут себя по last-note, glide предсказуем.

---

### M3. Осцилляторы (2 шт) + Sync
**Задачи**
- Osc1/Osc2: формы Saw/Square/Triangle.
- Параметры: Coarse/Fine, Phase (стартовая/сброс), Detune (включая "агрессивный/нестабильный" режим).
- Sync Osc2 → Osc1.
- Микс осцилляторов (уровни или баланс).

**Критерии**
- Осцилляторы звучат стабильно по тону; sync даёт ожидаемые "визжащие" гармоники без потери высоты.

---

### M4. ADSR (Amp + Filter) и модуляции
**Задачи**
- Amp ADSR: Attack/Decay/Sustain/Release.
- Filter ADSR: Attack/Decay/Sustain/Release, глубина модуляции cutoff.
- Velocity → amp; Velocity → drive (опционально, с интенсивностью).

**Критерии**
- Нет кликов на огибающих при разумных настройках; velocity влияет как задумано.

---

### M5. Разрушение сигнала (DestroyChain v1)
**Цепь (последовательно)**
1. Wavefold
2. Hard Clipping
3. Ring Modulation или FM (переключаемо)
4. Bitcrusher / Sample Rate Reduction

**Задачи**
- Реализовать каждый блок с Drive/Amount/Mix (dry/wet) и параметрическим сглаживанием.
- Sync к частоте ноты: там где применимо (например, частота модулятора в ringmod/fm, частота SRR как музыкально связанная опция/режим).
- Сохранить принцип: "ломаем звук сильно, но pitch следует ноте".

**Критерии**
- При экстремальных настройках звук становится индустриально-шумным/механическим, но основная высота воспринимается и следует MIDI.

---

### M6. Фильтр после искажений (LP/BP) + самовозбуждение
**Задачи**
- LP/BP, резонанс вплоть до self-osc, стабильность на разных SR.
- Keytracking (On/Off) + amount (если нужно).
- Cutoff модулируется огибающей (M4).

**Критерии**
- Резонанс достигает самовозбуждения без неуправляемых скачков/крашей; keytracking работает ожидаемо.

---

### M7. UI/UX (основной интерфейс v1)
**Задачи**
- Разметка блоков: Oscillators / Distortion-Mod / Filter / Envelopes / Output.
- Крутилки и тумблеры без меню; читаемые подписи, логичные группы.
- Индустриальный тёмный стиль (железо/энергия/техника), без "EDM-гламура".
- Привязка контролов к APVTS (`SliderAttachment`, `ButtonAttachment`).
- RU/EN: переключаемый язык (параметр `ui.language`) для подписей/тултипов/сообщений.
- Ресайз: окно можно менять по ширине/высоте (угол + границы), верстка не ломается.
- Интерактивный "Sculpt/Tone" блок: спектр-анализатор + drag low/high cut + peak (как быстрый Serum-подобный workflow).
  - Дополнительно: добавление/удаление peak-узлов мышью (до 8 peak).

**Критерии**
- Все параметры доступны из UI, автомейшн работает, UI не лагает и не "прыгает" при обновлениях.
- На RU/EN тексты не превращаются в "крякозябры" и не ломают компоновку.

---

### M8. Пресеты (Factory + User)
**Задачи**
- Встроенные factory presets (12–15): Industrial Bass (3–5), Aggressive Lead (3–5), Drone/Noise Tone (3–5).
- User presets: сохранение/загрузка в папку (например `Presets/User/`), список в UI (без сложных меню).
- Совместимость состояний: пресет = snapshot APVTS.
- При добавлении новых параметров: обновлять factory presets так, чтобы они задавали значения новых параметров (иначе будут "протекать" старые значения).

**Критерии**
- Пресеты грузятся мгновенно и воспроизводимо; при обновлении версии не ломают старые проекты (минимум: стабильные Parameter IDs).

---

### M9. QA, оптимизация, релизный билд
**Задачи**
- Тесты в Reaper: длительный прогон, переключение SR/Buffer, стресс автомейшна, быстрый MIDI input.
- Smoke-тесты в FL Studio и Cakewalk.
- Оптимизация: исключить аллокации в аудио-потоке, денормалы, лишние ветвления, зиппер-ноиз.
- Финальная сборка VST3 + версия + changelog.

**Чек-лист QA (Reaper)**
- Scan VST3 без ошибок; открыть/закрыть UI 50+ раз без падений.
- Project recall: сохранить проект с изменёнными параметрами, перезапустить Reaper, убедиться что всё восстановилось.
- Automation stress: авто-мейшн `filter.cutoffHz`, `destroy.*Mix`, `out.gainDb`, `tone.*` (в т.ч. peak1/2/3).
- SR/Buffer changes: 44.1/48/96 kHz + разные buffer size во время проигрывания.
- MIDI: быстрые повторяющиеся ноты, удержание/перекрытие, All Notes Off, Panic.
- Tone EQ/Spectrum: перетаскивание low/high cut + peak 1/2/3, Shift (Q), double-click (reset).
  - Добавление/удаление peak: double-click пусто = добавить, ПКМ по peak = удалить (до 8).
- Destroy OS: переключение Off/2x/4x во время проигрывания (без крашей/жёстких артефактов).

**Релизная сборка (Windows)**
- Вариант A (Ninja + cl, single-config):
  - Configure: `cmake -S . -B build-win-release -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=cl`
  - Build: `cmake --build build-win-release -j 8`
  - Артефакт VST3 обычно тут: `build-win-release/IndustrialEnergySynth_artefacts/Release/VST3/Industrial Energy Synth.vst3`
- Вариант B (Visual Studio generator, multi-config):
  - Configure: `cmake -S . -B build-win -G "Visual Studio 17 2022" -A x64`
  - Build Release: `cmake --build build-win --config Release -j 8`

**Установка в Reaper (VST3)**
- Создай отдельную папку, например `C:\\VST3` (без прав администратора).
- Скопируй папку `Industrial Energy Synth.vst3` в `C:\\VST3`.
- Reaper: `Options -> Preferences -> Plug-ins -> VST`:
  - Добавь `C:\\VST3` в `VST plug-in paths`.
  - Нажми `Re-scan` (или `Clear cache/re-scan`, если не подхватило).

**Критерии**
- Нет крашей/зависаний, CPU в пределах разумного для моно-синта, поведение одинаковое между хостами.

## Риски и решения (важно держать в фокусе)
- **Pitch vs дисторшн**: многие виды разрушения легко превращают звук в "шум без ноты". Нужны осмысленные режимы синхронизации (ringmod/fm/srr) и аккуратные диапазоны параметров.
- **Алиасинг**: искажения множат спектр; без oversampling возможно "цифровое стекло". Для MVP можно жить с этим, но диапазоны и фильтрация должны быть подобраны, а oversampling оставить на v1.1+.
- **Резонанс/self-osc**: обеспечить стабильность фильтра на разных sample rate и при больших значениях резонанса.
- **Стабильные IDs**: Parameter IDs нельзя менять после появления пресетов/проектов.

## После v1.0 (backlog)
- Oversampling (опционально/авто) для цепи разрушения.
- Полифония.
- Доп. источники (noise), sub-osc, доп. модуляции (LFO).
- FX (reverb/delay), arpeggiator, MPE.
